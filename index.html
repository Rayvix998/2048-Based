<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Based 2048</title>
    
    <meta name="base:app_id" content="REPLACE_WITH_YOUR_APP_ID" />
    <meta property="fc:frame" content="vnext" />
    <meta name="fc:miniapp" content='{"version": "next", "imageUrl": "https://2048-based.vercel.app/hero.png", "button": {"title": "Play Based 2048", "action": {"type": "launch_miniapp", "name": "Based 2048", "url": "https://2048-based.vercel.app/", "splashImageUrl": "https://2048-based.vercel.app/icon.png", "splashBackgroundColor": "#0052FF"}}}' />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <style>
        /* BASE THEME VARIABLES */
        :root {
            --base-blue: #0052FF;
            --base-black: #000000;
            --base-white: #FFFFFF;
            --base-gray: #F2F3F5;
            --grid-bg: #000000;
            --tile-empty: #F2F3F5;
            --gap: 10px;
            --grid-size: 80px;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--base-white);
            color: var(--base-black);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: none;
        }

        /* NAVBAR */
        nav {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            border-bottom: 2px solid var(--base-gray);
            background: white;
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--base-blue);
            letter-spacing: -0.5px;
        }

        .wallet-btn {
            background-color: var(--base-blue);
            color: var(--base-white);
            border: 2px solid var(--base-blue);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .wallet-btn.connected {
            background-color: var(--base-white);
            color: var(--base-black);
            border-color: var(--base-black);
        }

        /* TABS */
        .tabs {
            display: flex;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--base-blue);
            border-bottom-color: var(--base-blue);
        }

        /* GAME AREA */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .score-box {
            background: var(--base-black);
            color: white;
            padding: 10px 40px;
            border-radius: 12px;
            text-align: center;
        }
        .score-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        .score-val { font-size: 2.5rem; font-weight: 800; line-height: 1; }

        .grid {
            background-color: var(--grid-bg);
            padding: var(--gap);
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(4, var(--grid-size));
            grid-template-rows: repeat(4, var(--grid-size));
            gap: var(--gap);
            position: relative;
        }

        .tile {
            width: var(--grid-size);
            height: var(--grid-size);
            background-color: var(--tile-empty);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: 800;
            color: var(--base-black);
            transition: all 0.15s ease-in-out;
        }

        /* TILE COLORS */
        .t-2 { background: #E6F0FF; }
        .t-4 { background: #CCE0FF; }
        .t-8 { background: #99C2FF; }
        .t-16 { background: #66A3FF; color: white; }
        .t-32 { background: #3385FF; color: white; }
        .t-64 { background: #0066FF; color: white; }
        .t-128 { background: #0052FF; color: white; box-shadow: 0 0 10px #0052FF; }
        .t-256 { background: #0042CC; color: white; }
        .t-512 { background: #003399; color: white; }
        .t-1024 { background: #002466; color: white; }
        .t-2048 { background: var(--base-black); color: var(--base-blue); border: 2px solid var(--base-blue); }

        /* CONTROLS */
        .controls {
            display: grid;
            grid-template-columns: 60px 60px 60px;
            gap: 10px;
            margin-top: 20px;
        }
        .ctrl-btn {
            background: var(--base-black);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .ctrl-btn:active { transform: scale(0.9); background: var(--base-blue); }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 100;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .modal h2 { font-size: 3rem; margin: 0; color: var(--base-blue); }
        .save-btn {
            margin-top: 20px;
            background: var(--base-blue);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,82,255,0.3);
        }

        /* HISTORY */
        #history-list { width: 90%; max-width: 400px; margin-top: 20px; }
        .history-item {
            display: flex; justify-content: space-between; padding: 15px;
            border-bottom: 1px solid #eee; font-weight: 500;
        }

        @media (max-width: 400px) { :root { --grid-size: 70px; } }
    </style>
</head>
<body>

    <nav>
        <div class="logo">2048-BASED</div>
        <button id="connectWallet" class="wallet-btn">Connect Wallet</button>
    </nav>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('game')">Game</div>
        <div class="tab" onclick="switchTab('history')">History</div>
    </div>

    <div id="game-tab" class="game-container">
        <div class="score-box">
            <div class="score-label">Score</div>
            <div class="score-val" id="score">0</div>
        </div>
        <div class="grid" id="grid"></div>
        <div class="controls">
            <div></div><button class="ctrl-btn" onclick="handleInput('ArrowUp')">â–²</button><div></div>
            <button class="ctrl-btn" onclick="handleInput('ArrowLeft')">â—€</button>
            <button class="ctrl-btn" onclick="handleInput('ArrowDown')">â–¼</button>
            <button class="ctrl-btn" onclick="handleInput('ArrowRight')">â–¶</button>
        </div>
        <p style="color:#888; font-size:0.8rem; margin-top:10px;">Use Arrow Keys or Buttons</p>
    </div>

    <div id="history-tab" style="display:none; width:100%; flex-direction:column; align-items:center;">
        <h3 style="color:var(--base-blue)">On-Chain History</h3>
        <div id="history-list"><p style="color:#888; margin-top:20px;">Connect wallet to view history.</p></div>
    </div>

    <div class="modal" id="modal">
        <h2>Game Over</h2>
        <p>Score: <span id="final-score" style="font-weight:bold;">0</span></p>
        <button class="save-btn" onclick="saveScore()">Save on Base ðŸ”µ</button>
        <button onclick="initGame()" style="background:none; border:none; color:#888; margin-top:20px; cursor:pointer; text-decoration:underline;">Play Again</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk@0.0.14/dist/bundle.min.js"></script>

    <script>
        // --- CONFIGURATION FOR MAINNET ---
        const CONTRACT_ADDRESS = "0xa3ed4A2BA35B01C120dBE82bb365aAe39E3Dc425"; // âœ… YOUR MAINNET CONTRACT
        const CHAIN_ID_HEX = "0x2105"; // 8453 (Base Mainnet)
        const CHAIN_ID_DEC = 8453;     // 8453 (Base Mainnet)

        // ABI
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"uint256","name":"_score","type":"uint256"}],"name":"saveScore","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"score","type":"uint256"}],"name":"ScoreSaved","type":"event"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getHistory","outputs":[{"components":[{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"score","type":"uint256"}],"internalType":"struct Based2048.GameRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"}
        ];

        // --- STATE ---
        let provider, signer, contract, userAddress;

        // --- CONNECT WALLET ---
        async function connectWallet() {
            if (!window.ethereum) return alert("Please install MetaMask!");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // FORCE SWITCH TO BASE MAINNET
                const network = await provider.getNetwork();
                if (network.chainId !== CHAIN_ID_DEC) await switchNetwork();

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                const btn = document.getElementById('connectWallet');
                btn.innerText = userAddress.substring(0, 6) + "...";
                btn.classList.add('connected');
                loadHistory();

            } catch (err) {
                console.error("Connection Error:", err);
                alert("Connection failed: " + (err.reason || err.message));
            }
        }

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CHAIN_ID_HEX }],
                });
            } catch (err) {
                if (err.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: CHAIN_ID_HEX,
                            chainName: 'Base Mainnet',
                            rpcUrls: ['https://mainnet.base.org'],
                            nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                            blockExplorerUrls: ['https://basescan.org']
                        }],
                    });
                } else {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    throw err; 
                }
            }
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
        }

        document.getElementById('connectWallet').addEventListener('click', connectWallet);

        // --- SAVE SCORE ---
        async function saveScore() {
            const btn = document.querySelector('.save-btn');
            if (!contract) {
                await connectWallet();
                if (!contract) return;
            }
            try {
                const network = await provider.getNetwork();
                if (network.chainId !== CHAIN_ID_DEC) {
                    await switchNetwork();
                    return; 
                }

                btn.innerText = "Confirming...";
                const tx = await contract.saveScore(score);
                btn.innerText = "Saving...";
                await tx.wait();
                
                alert("Score Saved to Base Mainnet! âœ…");
                btn.innerText = "Saved âœ…";
                loadHistory();
            } catch (e) {
                console.error(e);
                btn.innerText = "Failed âŒ";
                setTimeout(() => btn.innerText = "Save on Base ðŸ”µ", 2000);
                alert("Transaction Failed: " + (e.reason || e.message || "Unknown error"));
            }
        }

        // --- HISTORY ---
        async function loadHistory() {
            if (!contract) return;
            const list = document.getElementById('history-list');
            try {
                const history = await contract.getHistory(userAddress);
                list.innerHTML = '';
                [...history].reverse().forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'history-item';
                    row.innerHTML = `<span>${item.score} Points</span> <span style="color:#888; font-size:0.8em">${new Date(item.timestamp * 1000).toLocaleDateString()}</span>`;
                    list.appendChild(row);
                });
                if (history.length === 0) list.innerHTML = "<p>No scores yet.</p>";
            } catch (e) { console.error(e); }
        }

        // --- GAME LOGIC ---
        let board = [], score = 0;
        function initGame() {
            board = Array(4).fill().map(() => Array(4).fill(0));
            score = 0;
            document.getElementById('score').innerText = '0';
            document.getElementById('modal').style.display = 'none';
            document.querySelector('.save-btn').innerText = "Save on Base ðŸ”µ";
            addNewTile(); addNewTile(); updateView();
        }
        function addNewTile() {
            let empty = [];
            for (let r = 0; r < 4; r++) for (let c = 0; c < 4; c++) if (board[r][c] == 0) empty.push({ r, c });
            if (empty.length > 0) {
                let { r, c } = empty[Math.floor(Math.random() * empty.length)];
                board[r][c] = Math.random() > 0.9 ? 4 : 2;
            }
        }
        function updateView() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    let val = board[r][c];
                    let div = document.createElement('div');
                    div.className = `tile t-${val}`;
                    div.innerText = val || '';
                    grid.appendChild(div);
                }
            }
        }
        function move(dir) {
            let rotated = [...board.map(r => [...r])];
            const rotate = m => m[0].map((v, i) => m.map(r => r[i]).reverse());
            if (dir === 'ArrowRight') rotated = rotated.map(r => r.reverse());
            else if (dir === 'ArrowUp') rotated = rotate(rotate(rotate(rotated)));
            else if (dir === 'ArrowDown') rotated = rotate(rotated);
            
            let newBoard = rotated.map(row => {
                let nums = row.filter(n => n);
                for (let i = 0; i < nums.length - 1; i++) {
                    if (nums[i] === nums[i + 1]) { nums[i] *= 2; score += nums[i]; nums[i + 1] = 0; }
                }
                nums = nums.filter(n => n);
                while (nums.length < 4) nums.push(0);
                return nums;
            });

            if (dir === 'ArrowRight') newBoard = newBoard.map(r => r.reverse());
            else if (dir === 'ArrowUp') newBoard = rotate(newBoard);
            else if (dir === 'ArrowDown') newBoard = rotate(rotate(rotate(newBoard)));

            if (JSON.stringify(board) !== JSON.stringify(newBoard)) {
                board = newBoard;
                addNewTile(); updateView();
                document.getElementById('score').innerText = score;
                checkGameOver();
            }
        }
        function checkGameOver() {
            let full = true;
            for(let r=0; r<4; r++) for(let c=0; c<4; c++) if(board[r][c]===0) full = false;
            if(full) {
                let stuck = true;
                for(let r=0; r<4; r++) {
                    for(let c=0; c<4; c++) {
                        if(c<3 && board[r][c]===board[r][c+1]) stuck = false;
                        if(r<3 && board[r][c]===board[r+1][c]) stuck = false;
                    }
                }
                if(stuck) {
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('modal').style.display = 'flex';
                }
            }
        }
        const handleInput = (k) => { if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(k)) move(k); }
        document.addEventListener('keydown', e => { if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) { e.preventDefault(); handleInput(e.key); } });
        
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('game-tab').style.display = t === 'game' ? 'flex' : 'none';
            document.getElementById('history-tab').style.display = t === 'history' ? 'flex' : 'none';
            if (t === 'history') loadHistory();
        }

        window.addEventListener('load', async () => {
            initGame();
            if (window.farcaster && window.farcaster.miniapp) await window.farcaster.miniapp.sdk.actions.ready();
        });
    </script>
</body>
</html>